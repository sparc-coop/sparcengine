@page "/Domains"
@using Sparc.Engine.Aura
@layout MainLayout

<PageTitle>Tovik</PageTitle>

<article class="home">
    <div class="page-container">

        <section class="word-usage">
            <header>
                <h3>Word Usage</h3>
                <p class="subheader">Tovik includes 100,000 words by default. If you need additional words, you can purchase a word pack anytime.</p>
            </header>
            <div>
                <h4>Remaining words</h4>
                <UsageMeter Usage=Usage Limit=Limit />
            </div>
            <div class="btn-container">
                <button class="purchase-btn primary-btn">Need more words?</button>
            </div>
        </section>

        <section class="add-domain">
            <header>
                <h3>Add a Domain</h3>
                <p class="subheader">There’s no limit to the number of domains you can add. You can add or remove domains at anytime.</p>
            </header>

            @if (Error != null)
            {
                <div class="error-message">@Error</div>
            }

            <label>
                <input type="text" placeholder="Enter a domain name" @bind="NewDomain" @bind:event="oninput" />
            </label>
            <div class="btn-container">
                <button class="add-btn primary-btn" disabled="@(string.IsNullOrWhiteSpace(NewDomain))" @onclick=AddDomain>Add Domain</button>
            </div>
        </section>

        <section class="manage-domains">
            <header>
                <h3>Manage Domains</h3>
                <p class="subheader">Change the display name, delete a domain, or add exempt words/phrases to your domain glossary.</p>
            </header>
            <table class="domains-table">
                <thead>
                    <tr>
                        <td>Domain</td>
                        <td>Usage</td>
                        <td></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var domain in Domains)
                    {
                        <DomainCard Domain=domain PageType="home" OnDelete=DeleteDomain />
                    }
                </tbody>
            </table>
        </section>

    </div>
</article>

@inject Tovik.Domains.TovikDomains TovikDomains
@inject ISparcAura Aura
@code {
    List<SparcDomain> Domains = new();
    string NewDomain = "";
    string? Error;

    int Usage;
    int Limit;

    protected override async Task OnInitializedAsync()
    {
        var user = await Aura.UserInfo();
        var product = user.Product("Tovik");
        await LoadDomains();
        Limit = product?.MaxUsage ?? 500;
        Usage = Domains.Sum(d => d.TovikUsage);
    }

    private async Task LoadDomains()
    {
        Domains = await TovikDomains.All();
    }

    private async Task AddDomain()
    {
        if (string.IsNullOrWhiteSpace(NewDomain))
            return;

        Error = null;
        try
        {
            await TovikDomains.RegisterAsync(NewDomain);
            NewDomain = "";
            await LoadDomains();
        }
        catch (Exception ex)
        {
            Error = ex.Message;
            NewDomain = "";
        }
    }

    private async Task DeleteDomain(SparcDomain domain)
    {
        await TovikDomains.Delete(domain);
        await LoadDomains();
    }
}